{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Workflow State Schema",
  "description": "Tracks the current state of the product development workflow across all stages",
  "type": "object",
  "required": [
    "workflow_id",
    "execution_mode",
    "current_stage",
    "stages",
    "created_at",
    "updated_at"
  ],
  "properties": {
    "workflow_id": {
      "type": "string",
      "description": "Unique identifier for this workflow execution"
    },
    "product_name": {
      "type": "string",
      "description": "Name of the product or feature being built"
    },
    "execution_mode": {
      "type": "string",
      "enum": ["full_system", "fast_feature"],
      "description": "Determines the depth and scope of the workflow"
    },
    "current_stage": {
      "type": "string",
      "enum": [
        "requirements",
        "architecture",
        "frontend_implementation",
        "backend_implementation",
        "ai_implementation",
        "qa_testing",
        "deployment",
        "safety_review",
        "governance_review",
        "code_health_assessment",
        "completed",
        "failed",
        "paused"
      ]
    },
    "stages": {
      "type": "object",
      "description": "Status of each stage in the workflow",
      "properties": {
        "requirements": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "product_manager"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "human_approval_required": {"type": "boolean", "default": true},
            "human_approval_received": {"type": "boolean"},
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "architecture": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "system_architect"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "human_approval_required": {"type": "boolean"},
            "human_approval_received": {"type": "boolean"},
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "frontend_implementation": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "frontend_engineer"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "backend_implementation": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "backend_engineer"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "ai_implementation": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "ai_engineer"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "qa_testing": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "qa_engineer"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "qa_recommendation": {
              "type": "string",
              "enum": ["approve_for_deployment", "needs_fixes", "major_issues"]
            },
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "deployment": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped", "rolled_back"]
            },
            "agent": {"type": "string", "default": "devops_engineer"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "environment": {"type": "string"},
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "safety_review": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "safety_agent"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "governance_review": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "governance_agent"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        },
        "code_health_assessment": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed", "blocked", "skipped"]
            },
            "agent": {"type": "string", "default": "code_health_agent"},
            "started_at": {"type": "string", "format": "date-time"},
            "completed_at": {"type": "string", "format": "date-time"},
            "output_artifacts": {"type": "array", "items": {"type": "string"}},
            "health_rating": {
              "type": "string",
              "enum": ["excellent", "good", "acceptable", "needs_improvement", "critical"]
            },
            "blocking_issues": {"type": "array", "items": {"type": "string"}}
          }
        }
      }
    },
    "parallel_execution": {
      "type": "object",
      "description": "Tracks which stages can run in parallel",
      "properties": {
        "enabled": {"type": "boolean", "default": false},
        "parallel_stages": {
          "type": "array",
          "items": {
            "type": "array",
            "items": {"type": "string"}
          }
        }
      }
    },
    "safety_and_governance": {
      "type": "object",
      "properties": {
        "safety_review_status": {
          "type": "string",
          "enum": ["pending", "in_progress", "passed", "blocked", "not_required"]
        },
        "governance_review_status": {
          "type": "string",
          "enum": ["pending", "in_progress", "passed", "blocked", "not_required"]
        },
        "risk_level": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        }
      }
    },
    "human_interactions": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["timestamp", "stage", "interaction_type"],
        "properties": {
          "timestamp": {"type": "string", "format": "date-time"},
          "stage": {"type": "string"},
          "interaction_type": {
            "type": "string",
            "enum": ["approval", "rejection", "clarification", "feedback", "decision"]
          },
          "details": {"type": "string"}
        }
      }
    },
    "blocking_issues": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["issue_id", "stage", "description", "severity"],
        "properties": {
          "issue_id": {"type": "string"},
          "stage": {"type": "string"},
          "description": {"type": "string"},
          "severity": {"type": "string", "enum": ["low", "medium", "high", "critical"]},
          "resolution_required_before_proceeding": {"type": "boolean"},
          "resolved": {"type": "boolean"},
          "resolution_notes": {"type": "string"}
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "created_by": {"type": "string"},
        "project_name": {"type": "string"},
        "tags": {"type": "array", "items": {"type": "string"}},
        "estimated_completion_date": {"type": "string", "format": "date"},
        "actual_completion_date": {"type": "string", "format": "date"}
      }
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time"
    }
  }
}
